<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora TSG</title>

  <meta property="og:title" content="Calculadora TSG" />
  <meta property="og:description" content="Gera anúncio pronto (valores + vagas) para postar no WhatsApp." />
  <meta property="og:type" content="website" />

  <style>
    :root{
      --text:#e5e7eb;
      --muted:#94a3b8;
      --stroke:#243244;

      --off-bg: rgba(148,163,184,.10);
      --off-br: rgba(148,163,184,.28);

      --on-bg: rgba(34,197,94,.18);
      --on-br: rgba(34,197,94,.45);
      --on-tx: #dcfce7;

      --danger-bg: rgba(239,68,68,.16);
      --danger-br: rgba(239,68,68,.40);

      --copy-bg: rgba(31,111,235,.95);
      --copy-br: rgba(31,111,235,.95);

      --wa-bg: rgba(34,197,94,.18);
      --wa-br: rgba(34,197,94,.45);
      --wa-tx: #dcfce7;

      --ring: rgba(34,197,94,.85);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#070a0f, #0b1220 45%, #070a0f);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:920px;margin:0 auto;padding:16px 14px 30px}
    h1{margin:0;font-size:22px;letter-spacing:-0.2px}
    .hint{color:var(--muted);font-size:13px;line-height:1.3;margin-top:6px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }

    .col{display:flex;flex-direction:column;gap:12px;min-width:0}

    .card{
      background:rgba(17,24,39,.72);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:14px;
      backdrop-filter: blur(6px);
      min-width:0;
    }

    .label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px}

    input{
      width:100%;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.55);
      color:var(--text);
      border-radius:14px;
      padding:11px 12px;
      font-size:16px;
      outline:none;
    }

    .rowFields{
      display:flex;
      gap:8px;
      align-items:flex-end;
      flex-wrap:nowrap;
      margin-top:12px;
    }
    .colPrice{flex:0 0 150px; min-width:0}
    .colFlex{flex:1 1 auto; min-width:0}
    @media (max-width:520px){
      .rowFields{flex-wrap:wrap}
      .colPrice{flex:1 1 140px}
      .colFlex{flex:1 1 240px}
    }

    .toggleLine{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .toggle input{ width:0;height:0;opacity:0;position:absolute; }
    .dot{
      width:18px;height:18px;border-radius:999px;
      border:2px solid rgba(148,163,184,.55);
      background:transparent;
      display:inline-block;
      position:relative;
    }
    .toggle input:checked + .dot{ border-color: rgba(34,197,94,.65); }
    .toggle input:checked + .dot::after{
      content:"";
      position:absolute;
      width:10px;height:10px;border-radius:999px;
      background: rgba(34,197,94,.75);
      left:50%;top:50%;
      transform:translate(-50%,-50%);
    }
    .toggleText{ color:var(--muted); font-size:13px; }

    input[type="date"]{ font-size:15px; padding:10px 12px; }

    button{
      border:1px solid var(--off-br);
      background:var(--off-bg);
      color:var(--text);
      border-radius:14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    button:active{transform:translateY(1px)}
    button.on{
      background:var(--on-bg);
      border-color:rgba(34,197,94,.45);
      color:var(--on-tx);
    }
    button.disabled{ opacity:.55; cursor:not-allowed; }

    .iconWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      min-width:0;
    }
    .iconCaption{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      line-height:1.1;
    }
    .iconWrap.active .iconCaption{ color: var(--on-tx); }
    .iconWrap.disabled .iconCaption{ opacity:.70; }

    /* botões menores */
    .iconBtn{
      height:42px;
      width:100%;
      max-width:72px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      font-size:0;
      position:relative;
    }
    .iconBtn svg{ width:19px;height:19px; display:block; }

    .iconWrap.active .iconBtn{
      border-color: var(--ring);
      box-shadow:
        0 0 0 2px rgba(34,197,94,.55),
        0 0 0 6px rgba(34,197,94,.12),
        0 0 14px rgba(34,197,94,.16);
    }
    .iconWrap.active .iconBtn::after{
      content:"";
      position:absolute;
      inset:3px;
      border-radius:12px;
      box-shadow: inset 0 0 0 1px rgba(34,197,94,.22);
      pointer-events:none;
    }

    .okIcon{display:none}
    .iconBtn.ok .mainIcon{display:none}
    .iconBtn.ok .okIcon{display:block}

    .copy{
      background:var(--copy-bg);
      border-color:var(--copy-br);
      color:white;
      font-weight:700;
    }
    .clear{
      background:var(--danger-bg);
      border-color:var(--danger-br);
      color:#fee2e2;
      font-weight:700;
    }
    .whatsapp{
      background:var(--wa-bg);
      border-color:var(--wa-br);
      color:var(--wa-tx);
      font-weight:700;
    }

    .iconRow4{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      width:100%;
      align-items:start;
    }
    @media (max-width:520px){
      .iconRow4{grid-template-columns:1fr 1fr}
      .iconBtn{max-width:none}
    }

    .iconRow3{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      width:100%;
      align-items:start;
    }
    @media (max-width:520px){
      .iconRow3{grid-template-columns:1fr}
    }

    .note{
      margin-top:10px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }

    .slotsTitle{
      margin:0 0 10px;
      font-size:16px;
      letter-spacing:-0.1px;
      font-weight:700;
    }

    .slotsGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:820px){ .slotsGrid{grid-template-columns:1fr} }

    .mediaPreview{
      margin-top:10px;
      border:1px dashed rgba(148,163,184,.28);
      border-radius:14px;
      padding:10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .display{
      width:100%;
      max-width:100%;
      border:1px solid var(--stroke);
      background:radial-gradient(1200px 300px at 50% 0%, #18233a 0%, #0b1220 55%, #070a0f 100%);
      color:#eaf2ff;
      border-radius:16px;
      padding:14px;
      min-height:240px;
      resize:vertical;

      white-space:pre-wrap;
      overflow-wrap:anywhere;
      word-break:break-word;
      overflow-x:hidden;

      text-align:justify;
      text-justify:inter-word;

      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:15px;
      line-height:1.35;
      outline:none;
    }

    .toast{
      position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
      background:#0b1220;border:1px solid var(--stroke);color:var(--text);
      padding:10px 14px;border-radius:999px;font-size:14px;
      opacity:0;pointer-events:none;transition:opacity .2s;
    }
    .toast.show{opacity:.95}

    .svgCheck{ width:19px;height:19px; }

    .videoRow{
      display:flex;
      gap:8px;
      align-items:center;
    }
    /* lupa (menor) */
    .searchBtn{
      height:42px;
      width:46px;
      min-width:46px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:14px;
    }
    .searchBtn svg{ width:19px;height:19px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div>
      <h1>Calculadora TSG</h1>
      <div class="hint">Preencha os campos e o anúncio aparece no final, pronto para copiar.</div>
    </div>

    <div class="grid">
      <!-- ESQUERDA -->
      <div class="col">
        <div class="card">
          <label class="label">Nome do jogo</label>
          <input id="game" placeholder="Ex.: Monster Hunter Wilds" />

          <div class="rowFields">
            <div class="colPrice">
              <label class="label">Valor (R$)</label>
              <input id="price" inputmode="decimal" placeholder="300,00" />
            </div>

            <div class="colFlex">
              <div class="toggleLine">
                <label class="toggle">
                  <input id="promoEnable" type="checkbox" />
                  <span class="dot"></span>
                  <span class="toggleText">Promoção válida até</span>
                </label>
                <input id="promoDate" type="date" style="display:none; width: 220px; max-width:100%;" />
              </div>

              <div class="toggleLine">
                <label class="toggle">
                  <input id="preEnable" type="checkbox" />
                  <span class="dot"></span>
                  <span class="toggleText">Pré-venda. Lançamento previsto para:</span>
                </label>
                <input id="preDate" type="date" style="display:none; width: 220px; max-width:100%;" />
              </div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label class="label">Link do vídeo no YouTube (opcional)</label>
            <div class="videoRow">
              <input id="mediaUrl" inputmode="url" placeholder="Cole o link do YouTube aqui" />
              <button id="btnYoutubeSearch" class="searchBtn" type="button" aria-label="Buscar vídeo no YouTube" title="Buscar no YouTube">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="11" cy="11" r="7"></circle>
                  <path d="M21 21l-4.3-4.3"></path>
                </svg>
              </button>
            </div>
            <div id="mediaPreview" class="mediaPreview">Sem vídeo (opcional).</div>
          </div>

          <!-- CONTROLES (ícones) -->
          <div class="iconRow4" style="margin-top:14px">
            <div class="iconWrap" id="wrap_btnMulti">
              <button id="btnMulti" class="iconBtn" type="button" aria-label="PS4 e PS5" title="PS4 e PS5">
                <svg class="mainIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <rect x="4" y="6" width="16" height="12" rx="3"/>
                  <path d="M8 12h8"/>
                  <path d="M12 10v4"/>
                </svg>
              </button>
              <div class="iconCaption">PS4 e PS5</div>
            </div>

            <div class="iconWrap" id="wrap_btnExclusive">
              <button id="btnExclusive" class="iconBtn" type="button" aria-label="Exclusivo PS5" title="Exclusivo PS5">
                <svg class="mainIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <rect x="5" y="11" width="14" height="10" rx="2"/>
                  <path d="M8 11V8a4 4 0 0 1 8 0v3"/>
                  <path d="M12 16v2"/>
                </svg>
              </button>
              <div class="iconCaption">Exclusivo PS5</div>
            </div>

            <div class="iconWrap" id="wrap_btnG3">
              <button id="btnG3" class="iconBtn" type="button" aria-label="Grupo 3" title="Grupo 3">
                <svg class="mainIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="9" cy="8" r="3"/>
                  <circle cx="17" cy="9" r="2.5"/>
                  <path d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/>
                  <path d="M16 14h2a3.5 3.5 0 0 1 3.5 3.5V21"/>
                </svg>
              </button>
              <div class="iconCaption">Grupo 3</div>
            </div>

            <div class="iconWrap" id="wrap_btnG5">
              <button id="btnG5" class="iconBtn" type="button" aria-label="Grupo 5" title="Grupo 5">
                <svg class="mainIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="8" cy="8" r="3"/>
                  <circle cx="16" cy="8" r="3"/>
                  <path d="M2 21v-2a4 4 0 0 1 4-4h4"/>
                  <path d="M14 15h4a4 4 0 0 1 4 4v2"/>
                  <path d="M10 15h4"/>
                </svg>
              </button>
              <div class="iconCaption">Grupo 5</div>
            </div>
          </div>

          <div id="rulesNote" class="note"></div>
        </div>
      </div>

      <!-- DIREITA -->
      <div class="col">
        <div class="card">
          <div class="slotsTitle">Vagas</div>
          <div id="slots" class="slotsGrid"></div>
        </div>

        <div class="card">
          <textarea id="display" class="display" readonly></textarea>

          <!-- 3 botões finais: Copiar / WhatsApp / Limpar -->
          <div class="iconRow3">
            <div class="iconWrap" id="wrap_btnCopiar">
              <button id="btnCopiar" class="iconBtn copy" type="button" aria-label="Copiar anúncio" title="Copiar anúncio">
                <svg class="mainIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <svg class="okIcon svgCheck" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                     stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M20 6 9 17l-5-5"/>
                </svg>
              </button>
              <div class="iconCaption">Copiar anúncio</div>
            </div>

            <div class="iconWrap" id="wrap_btnWhats">
              <button id="btnWhats" class="iconBtn whatsapp" type="button" aria-label="WhatsApp" title="WhatsApp">
                <!-- ícone WhatsApp -->
                <svg class="mainIcon" viewBox="0 0 32 32" aria-hidden="true" fill="currentColor">
                  <path d="M16.02 3.2C9.1 3.2 3.5 8.8 3.5 15.7c0 2.44.7 4.82 2.03 6.87L4 28.8l6.38-1.48a12.44 12.44 0 0 0 5.64 1.35h.01c6.92 0 12.52-5.6 12.52-12.5S22.94 3.2 16.02 3.2zm7.28 17.78c-.3.86-1.75 1.64-2.45 1.76-.65.11-1.49.16-2.41-.14-.56-.18-1.29-.42-2.22-.82-3.9-1.68-6.45-5.6-6.64-5.86-.19-.26-1.57-2.1-1.57-4.01 0-1.91 1-2.85 1.35-3.24.35-.39.77-.49 1.03-.49h.74c.23 0 .54-.09.84.64.3.73 1.02 2.5 1.11 2.68.09.17.15.39.03.64-.12.26-.18.42-.35.64-.17.22-.36.49-.52.66-.17.17-.34.36-.15.7.19.35.83 1.36 1.78 2.2 1.22 1.08 2.25 1.41 2.6 1.58.35.17.56.14.77-.09.21-.22.89-1.04 1.13-1.4.24-.35.48-.3.81-.18.33.12 2.1.99 2.46 1.17.36.18.6.26.69.4.09.13.09.77-.21 1.63z"/>
                </svg>
              </button>
              <div class="iconCaption">WhatsApp</div>
            </div>

            <div class="iconWrap" id="wrap_btnLimpar">
              <button id="btnLimpar" class="iconBtn clear" type="button" aria-label="Limpar" title="Limpar">
                <svg class="mainIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M3 6h18"/>
                  <path d="M8 6V4h8v2"/>
                  <path d="M6 6l1 16h10l1-16"/>
                  <path d="M10 11v6"/>
                  <path d="M14 11v6"/>
                </svg>
              </button>
              <div class="iconCaption">Limpar</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Copiado!</div>

<script>
  const state = { groupSize: 3, mode: 'multi' };
  const STORAGE_KEY = 'tsg_calc_state_v1';

  function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 1400);
  }

  function setIconButtonOk(idBtn){
    const btn = document.getElementById(idBtn);
    btn.classList.add('ok');
    setTimeout(()=>btn.classList.remove('ok'), 1200);
  }

  function setActive(el, on){
    el.classList.toggle('on', !!on);
    const wrap = document.getElementById('wrap_' + el.id);
    if (wrap) wrap.classList.toggle('active', !!on);
  }

  function setDisabled(el, disabled){
    el.disabled = !!disabled;
    el.classList.toggle('disabled', !!disabled);
    const wrap = document.getElementById('wrap_' + el.id);
    if (wrap) wrap.classList.toggle('disabled', !!disabled);
  }

  function parseBRLToCents(str){
    if(!str) return 0;
    let s = String(str).trim();
    if(!s) return 0;
    s = s.replace(/\s/g,'').replace(/R\$/gi,'');
    if (s.includes(',')) s = s.replace(/\./g,'').replace(',','.');
    const n = Number(s);
    if (!isFinite(n) || n <= 0) return 0;
    return Math.round(n * 100);
  }

  function centsToBRL(cents){
    const n = (cents || 0) / 100;
    return n.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
  }

  function calcSharesNormal(totalCents, groupSize){
    if (groupSize === 3){
      const p = 0.40;
      const prim1 = Math.round(totalCents * p);
      const prim2 = Math.round(totalCents * p);
      const sec = totalCents - prim1 - prim2;
      return [prim1, prim2, sec];
    } else {
      const p = 0.225;
      const prim = [0,1,2,3].map(()=> Math.round(totalCents * p));
      const sumPrim = prim.reduce((a,b)=>a+b,0);
      const sec = totalCents - sumPrim;
      return [...prim, sec];
    }
  }

  function isExclusive(){ return state.mode === 'exclusive'; }
  function secondaryLabel(){ return isExclusive() ? 'Secundária PS5' : 'Secundária (PS4/PS5)'; }

  function fmtDateBRFromISO(iso){
    if (!iso) return '';
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso);
    if (!m) return '';
    return `${m[3]}/${m[2]}/${m[1]}`;
  }

  function slotDefs(){
    const sec = secondaryLabel();
    if (state.groupSize === 5){
      return [
        {key:'ps4p1', label:'Primária 1 PS4'},
        {key:'ps4p2', label:'Primária 2 PS4'},
        {key:'ps5p1', label:'Primária 1 PS5'},
        {key:'ps5p2', label:'Primária 2 PS5'},
        {key:'sec',   label: sec}
      ];
    }
    return [
      {key:'ps5p1', label:'Primária 1 PS5'},
      {key:'ps5p2', label:'Primária 2 PS5'},
      {key:'sec',   label: sec}
    ];
  }

  function refreshRulesNote(){
    const el = document.getElementById('rulesNote');
    if (state.groupSize === 3){
      el.textContent = 'Regras: Grupo 3 = 40% (cada primária) e 20% (secundária).';
    } else {
      el.textContent = 'Regras: Grupo 5 = 22,5% (cada primária) e 10% (secundária).';
    }
  }

  function refreshButtons(){
    setActive(document.getElementById('btnMulti'), state.mode === 'multi');
    setActive(document.getElementById('btnExclusive'), state.mode === 'exclusive');

    setActive(document.getElementById('btnG3'), state.groupSize === 3);
    setActive(document.getElementById('btnG5'), state.groupSize === 5);

    const btnG5 = document.getElementById('btnG5');
    setDisabled(btnG5, isExclusive());

    if (isExclusive() && state.groupSize === 5){
      state.groupSize = 3;
      setActive(document.getElementById('btnG3'), true);
      setActive(btnG5, false);
    }
    refreshRulesNote();
  }

  function buildSlots(savedNames){
    const wrap = document.getElementById('slots');
    wrap.innerHTML = '';
    slotDefs().forEach(d=>{
      const div = document.createElement('div');
      div.innerHTML = `
        <label class="label">${d.label}</label>
        <input id="name_${d.key}" placeholder="vaga" />
      `;
      wrap.appendChild(div);
    });

    // restore nomes
    if (savedNames){
      slotDefs().forEach(d=>{
        const v = savedNames[d.key];
        if (typeof v === 'string') document.getElementById(`name_${d.key}`).value = v;
      });
    }

    slotDefs().forEach(d=>{
      document.getElementById(`name_${d.key}`).addEventListener('input', () => {
        saveState();
        render();
      });
    });
  }

  // ==== YouTube only ====
  function normalizeYoutubeUrl(raw){
    if (!raw) return null;
    let s = String(raw).trim();
    if (!s) return null;

    if (!/^https?:\/\//i.test(s)) s = 'https://' + s;

    let u;
    try { u = new URL(s); } catch { return null; }

    const host = u.hostname.replace(/^www\./,'').toLowerCase();

    if (host === 'youtu.be'){
      const id = u.pathname.replace('/','').trim();
      if (!id) return null;
      return { id, url: `https://youtu.be/${id}` };
    }

    if (host === 'youtube.com' || host.endsWith('.youtube.com')){
      if (u.pathname === '/watch'){
        const id = u.searchParams.get('v');
        if (!id) return null;
        return { id, url: `https://www.youtube.com/watch?v=${id}` };
      }
      const mShorts = /^\/shorts\/([^\/\?]+)/.exec(u.pathname);
      if (mShorts) {
        const id = mShorts[1];
        return { id, url: `https://www.youtube.com/shorts/${id}` };
      }
      const mEmbed = /^\/embed\/([^\/\?]+)/.exec(u.pathname);
      if (mEmbed) {
        const id = mEmbed[1];
        return { id, url: `https://www.youtube.com/watch?v=${id}` };
      }
    }

    return null;
  }

  function getYoutube(){
    const raw = (document.getElementById('mediaUrl').value || '').trim();
    return normalizeYoutubeUrl(raw);
  }

  // preview sem iframe (evita avisos do YouTube no console)
  function updateMediaPreview(){
    const box = document.getElementById('mediaPreview');
    const raw = (document.getElementById('mediaUrl').value || '').trim();

    if (!raw){
      box.textContent = 'Sem vídeo (opcional).';
      return;
    }

    const yt = getYoutube();
    if (!yt){
      box.innerHTML = `⚠️ Apenas links do <b>YouTube</b> são aceitos.<br><small style="color:var(--muted)">Ex.: https://youtu.be/ID ou https://www.youtube.com/watch?v=ID</small>`;
      return;
    }

    const safe = yt.url.replace(/</g,'&lt;').replace(/>/g,'&gt;');
    box.innerHTML = `✅ Link do YouTube detectado:<br><small style="color:var(--muted)">${safe}</small>`;
  }

  // Para evitar "aba em branco" no iPhone:
  // a lupa abre o YouTube NA MESMA ABA, salvando o estado antes.
  function openYoutubeSearch(){
    const q = (document.getElementById('game').value || '').trim();
    const url = q ? `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}` : 'https://www.youtube.com/';
    saveState();
    window.location.href = url;
  }

  // tenta preencher o campo com o que estiver no clipboard (quando voltar pro navegador)
  async function tryAutofillFromClipboard(){
    try{
      if (!navigator.clipboard || !window.isSecureContext) return;
      const txt = (await navigator.clipboard.readText())?.trim();
      if (!txt) return;

      const yt = normalizeYoutubeUrl(txt);
      if (!yt) return;

      const inp = document.getElementById('mediaUrl');
      const cur = inp.value.trim();
      if (cur && normalizeYoutubeUrl(cur)) return;

      inp.value = yt.url;
      updateMediaPreview();
      saveState();
      render();
      showToast('Link do YouTube preenchido');
    } catch {
      // iOS pode bloquear leitura do clipboard sem gesto do usuário
    }
  }

  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') tryAutofillFromClipboard();
  });
  window.addEventListener('focus', () => tryAutofillFromClipboard());

  function buildAnnouncementText(){
    const game = (document.getElementById('game').value || '').trim();
    const totalCents = parseBRLToCents(document.getElementById('price').value);

    const promoEnabled = document.getElementById('promoEnable').checked;
    const promoISO = promoEnabled ? (document.getElementById('promoDate').value || '') : '';
    const promoBR = fmtDateBRFromISO(promoISO);

    const preEnabled = document.getElementById('preEnable').checked;
    const preISO = preEnabled ? (document.getElementById('preDate').value || '') : '';
    const preBR = fmtDateBRFromISO(preISO);

    if (!game || totalCents <= 0){
      return "Visualização do anúncio";
    }

    const shares = calcSharesNormal(totalCents, state.groupSize);
    const secLabel = secondaryLabel();
    const defs = slotDefs();

    const lines = [];

    const yt = getYoutube();
    if (yt){
      lines.push(`Vídeo: ${yt.url}`);
      lines.push('');
    }

    lines.push(game);
    lines.push(`Valor: ${centsToBRL(totalCents)}`);

    if (promoEnabled && promoBR) lines.push(`Promoção válida até ${promoBR}`);
    if (preEnabled && preBR) lines.push(`Pré-venda. Lançamento previsto para: ${preBR}`);

    lines.push('');

    if (state.groupSize === 3){
      lines.push(`Primárias PS5 - ${centsToBRL(shares[0])}`);
      lines.push(`${secLabel} - ${centsToBRL(shares[2])}`);
    } else {
      lines.push(`Primárias PS4 - ${centsToBRL(shares[0])}`);
      lines.push(`Primárias PS5 - ${centsToBRL(shares[2])}`);
      lines.push(`${secLabel} - ${centsToBRL(shares[4])}`);
    }

    lines.push('');
    defs.forEach(d=>{
      const name = (document.getElementById(`name_${d.key}`)?.value || '').trim() || 'vaga';
      lines.push(`${d.label} - ${name}`);
    });

    lines.push('');
    lines.push('Se o grupo fechar sem a Secundária, o valor será redistribuído entre as Primárias.');

    return lines.join('\n');
  }

  function render(){
    document.getElementById('display').value = buildAnnouncementText();
  }

  async function copyText(text){
    if (!text) return false;
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return !!ok;
    } catch(e){
      return false;
    }
  }

  async function copiarAnuncio(){
    const text = (buildAnnouncementText() || '').trim();
    const ok = await copyText(text);
    if (ok){
      showToast('Copiado!');
      setIconButtonOk('btnCopiar');
    } else {
      showToast('Selecione e copie');
    }
  }

  function abrirWhatsApp(){
    const text = (buildAnnouncementText() || '').trim();
    if (!text || text === 'Visualização do anúncio'){
      showToast('Preencha nome e valor');
      return;
    }
    // para evitar "aba em branco" no iPhone, abre na mesma aba
    window.location.href = 'https://api.whatsapp.com/send?text=' + encodeURIComponent(text);
  }

  function limpar(){
    document.getElementById('game').value = '';
    document.getElementById('price').value = '';
    document.getElementById('mediaUrl').value = '';

    document.getElementById('promoEnable').checked = false;
    document.getElementById('promoDate').value = '';
    document.getElementById('promoDate').style.display = 'none';

    document.getElementById('preEnable').checked = false;
    document.getElementById('preDate').value = '';
    document.getElementById('preDate').style.display = 'none';

    state.groupSize = 3;
    state.mode = 'multi';

    refreshButtons();
    buildSlots();
    updateMediaPreview();
    render();

    localStorage.removeItem(STORAGE_KEY);

    showToast('Limpo!');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function setMode(mode){
    if (mode === state.mode) return;
    state.mode = mode;
    if (isExclusive()) state.groupSize = 3;
    refreshButtons();
    // preserva valores já digitados nas vagas
    const names = collectSlotNames();
    buildSlots(names);
    saveState();
    render();
  }

  function setGroup(size){
    if (size === 5 && isExclusive()) return;
    state.groupSize = size;
    refreshButtons();
    const names = collectSlotNames();
    buildSlots(names);
    saveState();
    render();
  }

  function toggleDateInput(enableId, dateId){
    const en = document.getElementById(enableId);
    const dt = document.getElementById(dateId);
    dt.style.display = en.checked ? 'block' : 'none';
    if (!en.checked) dt.value = '';
    saveState();
    render();
  }

  function collectSlotNames(){
    const out = {};
    slotDefs().forEach(d=>{
      const el = document.getElementById(`name_${d.key}`);
      if (el) out[d.key] = el.value || '';
    });
    return out;
  }

  function saveState(){
    try{
      const payload = {
        mode: state.mode,
        groupSize: state.groupSize,
        game: document.getElementById('game').value || '',
        price: document.getElementById('price').value || '',
        promoEnable: !!document.getElementById('promoEnable').checked,
        promoDate: document.getElementById('promoDate').value || '',
        preEnable: !!document.getElementById('preEnable').checked,
        preDate: document.getElementById('preDate').value || '',
        mediaUrl: document.getElementById('mediaUrl').value || '',
        slotNames: collectSlotNames()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    } catch {}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch { return null; }
  }

  function applyLoadedState(s){
    if (!s) return;

    state.mode = (s.mode === 'exclusive') ? 'exclusive' : 'multi';
    state.groupSize = (s.groupSize === 5) ? 5 : 3;
    if (state.mode === 'exclusive') state.groupSize = 3;

    document.getElementById('game').value = s.game || '';
    document.getElementById('price').value = s.price || '';

    document.getElementById('promoEnable').checked = !!s.promoEnable;
    document.getElementById('promoDate').value = s.promoDate || '';
    document.getElementById('promoDate').style.display = s.promoEnable ? 'block' : 'none';

    document.getElementById('preEnable').checked = !!s.preEnable;
    document.getElementById('preDate').value = s.preDate || '';
    document.getElementById('preDate').style.display = s.preEnable ? 'block' : 'none';

    document.getElementById('mediaUrl').value = s.mediaUrl || '';
    const yt = getYoutube();
    if (yt) document.getElementById('mediaUrl').value = yt.url;

    refreshButtons();
    buildSlots(s.slotNames || {});
    updateMediaPreview();
    render();
  }

  function init(){
    // restaura estado (importante para quando você sai pra buscar no YouTube e volta)
    applyLoadedState(loadState());

    document.getElementById('btnMulti').addEventListener('click', ()=>setMode('multi'));
    document.getElementById('btnExclusive').addEventListener('click', ()=>setMode('exclusive'));
    document.getElementById('btnG3').addEventListener('click', ()=>setGroup(3));
    document.getElementById('btnG5').addEventListener('click', ()=>setGroup(5));

    document.getElementById('btnCopiar').addEventListener('click', copiarAnuncio);
    document.getElementById('btnWhats').addEventListener('click', abrirWhatsApp);
    document.getElementById('btnLimpar').addEventListener('click', limpar);

    document.getElementById('btnYoutubeSearch').addEventListener('click', openYoutubeSearch);

    document.getElementById('game').addEventListener('input', ()=>{ saveState(); render(); });
    document.getElementById('price').addEventListener('input', ()=>{ saveState(); render(); });

    document.getElementById('promoEnable').addEventListener('change', ()=>toggleDateInput('promoEnable','promoDate'));
    document.getElementById('promoDate').addEventListener('change', ()=>{ saveState(); render(); });

    document.getElementById('preEnable').addEventListener('change', ()=>toggleDateInput('preEnable','preDate'));
    document.getElementById('preDate').addEventListener('change', ()=>{ saveState(); render(); });

    document.getElementById('mediaUrl').addEventListener('input', ()=>{
      const yt = getYoutube();
      if (yt) document.getElementById('mediaUrl').value = yt.url;
      updateMediaPreview();
      saveState();
      render();
    });

    // se não tinha estado salvo, inicializa UI padrão
    if (!loadState()){
      refreshButtons();
      buildSlots();
      updateMediaPreview();
      render();
      saveState();
    }
  }

  init();
</script>
</body>
</html>
